Feature: CLI vulnerability list command

  Scenario Outline: CLI vulnerability list
    Given a `<release>` `<machine_type>` machine with ubuntu-advantage-tools installed
    When I verify that running `pro vulnerability list --series=jammy` `as non-root` exits `1`
    Then I will see the following on stderr:
      """
      Error: series depends on manifest_file to work properly.
      """
    When I verify that running `pro vulnerability list --all --unfixable` `as non-root` exits `1`
    Then I will see the following on stderr:
      """
      Error: Cannot use unfixable together with all.
      """
    When I create the file `/tmp/manifest` with the following:
      """
      libtasn1-6         4.7-3ubuntu0.16.04.3
      libzstd1:amd64     1.3.1+dfsg-1~ubuntu0.16.04.1
      screen             4.3.1-2ubuntu0.1
      snapd              2.48.3
      """
    And I push static file `security_issues_xenial` to machine
    And I run `pro vulnerability list --data-file=/tmp/security_issues_xenial --manifest-file=/tmp/manifest` as non-root
    And I remove colors from output
    And I remove links from output
    Then I will see the following on stdout:
      """
      Common vulnerabilities and exposures (CVE):
      VULNERABILITY     PRIORITY    FIX AVAILABLE FROM  AFFECTED INSTALLED PACKAGES
      CVE-2021-44730    high        esm-infra           snapd
      CVE-2021-44731    high        esm-infra           snapd
      CVE-2022-3328     high        esm-infra           snapd
      CVE-2019-11922    medium      esm-infra           libzstd1
      CVE-2021-3155     medium      esm-infra           snapd
      CVE-2021-4120     medium      esm-infra           snapd
      CVE-2023-1523     medium      esm-infra           snapd
      CVE-2021-46848    low         esm-infra           libtasn1-6
      CVE-2023-24626    low         esm-infra           screen
      CVE-2018-1000654  negligible  esm-infra           libtasn1-6

      Vulnerabilities with applied fixes:
          13 applied via Ubuntu Security (2 high, 6 medium, 5 low)

      Vulnerabilities with fixes available:
          10 fixable via Ubuntu Pro (3 high, 4 medium, 2 low, 1 negligible)
      """
    When I run `pro vulnerability list --all --data-file=/tmp/security_issues_xenial --manifest-file=/tmp/manifest` as non-root
    And I remove colors from output
    And I remove links from output
    Then I will see the following on stdout:
      """
      Common vulnerabilities and exposures (CVE):
      VULNERABILITY     PRIORITY    FIX AVAILABLE FROM  AFFECTED INSTALLED PACKAGES
      CVE-2021-44730    high        esm-infra           snapd
      CVE-2021-44731    high        esm-infra           snapd
      CVE-2022-3328     high        esm-infra           snapd
      CVE-2019-11840    medium      no-fix              snapd
      CVE-2019-11922    medium      esm-infra           libzstd1
      CVE-2021-24031    medium      no-fix              libzstd1
      CVE-2021-24032    medium      no-fix              libzstd1
      CVE-2021-3155     medium      esm-infra           snapd
      CVE-2021-4120     medium      esm-infra           snapd
      CVE-2022-28948    medium      no-fix              snapd
      CVE-2023-1523     medium      esm-infra           snapd
      CVE-2024-1724     medium      no-fix              snapd
      CVE-2024-29068    medium      no-fix              snapd
      CVE-2024-29069    medium      no-fix              snapd
      CVE-2017-3204     low         no-fix              snapd
      CVE-2021-46848    low         esm-infra           libtasn1-6
      CVE-2023-24626    low         esm-infra           screen
      CVE-2024-5138     low         no-fix              snapd
      CVE-2018-1000654  negligible  esm-infra           libtasn1-6

      Vulnerabilities with applied fixes:
          13 applied via Ubuntu Security (2 high, 6 medium, 5 low)

      Vulnerabilities with fixes available:
          10 fixable via Ubuntu Pro (3 high, 4 medium, 2 low, 1 negligible)

      Vulnerabilities with no fixes available:
          9 unfixable vulnerabilities found (7 medium, 2 low)
      """
    When I run `pro vulnerability list --unfixable --data-file=/tmp/security_issues_xenial --manifest-file=/tmp/manifest` as non-root
    And I remove colors from output
    And I remove links from output
    Then I will see the following on stdout:
      """
      Common vulnerabilities and exposures (CVE):
      VULNERABILITY   PRIORITY  FIX AVAILABLE FROM  AFFECTED INSTALLED PACKAGES
      CVE-2019-11840  medium    no-fix              snapd
      CVE-2021-24031  medium    no-fix              libzstd1
      CVE-2021-24032  medium    no-fix              libzstd1
      CVE-2022-28948  medium    no-fix              snapd
      CVE-2024-1724   medium    no-fix              snapd
      CVE-2024-29068  medium    no-fix              snapd
      CVE-2024-29069  medium    no-fix              snapd
      CVE-2017-3204   low       no-fix              snapd
      CVE-2024-5138   low       no-fix              snapd

      Vulnerabilities with applied fixes:
          13 applied via Ubuntu Security (2 high, 6 medium, 5 low)

      Vulnerabilities with no fixes available:
          9 unfixable vulnerabilities found (7 medium, 2 low)
      """
    When I run `pro vulnerability list --usns --data-file=/tmp/security_issues_xenial --manifest-file=/tmp/manifest` as non-root
    And I remove colors from output
    And I remove links from output
    Then I will see the following on stdout:
      """
      Ubuntu Security Notices (USN):
      VULNERABILITY  FIX AVAILABLE FROM  AFFECTED INSTALLED PACKAGES
      USN-5292-3     esm-infra           snapd
      USN-5352-1     esm-infra           libtasn1-6
      USN-5593-1     esm-infra           libzstd1
      USN-5707-1     esm-infra           libtasn1-6
      USN-5720-1     esm-infra           libzstd1

      Vulnerabilities with applied fixes:
          1 applied via Ubuntu Security

      Vulnerabilities with fixes available:
          5 fixable via Ubuntu Pro
      """
    When I create the file `/tmp/manifest` with the following:
      """
      foobat         1.0
      """
    When I run `pro vulnerability list --data-file=/tmp/security_issues_xenial --manifest-file=/tmp/manifest` as non-root
    And I remove colors from output
    Then I will see the following on stdout:
      """
      No CVEs found that affects this system
      """
    When I run `pro vulnerability list --usns --data-file=/tmp/security_issues_xenial --manifest-file=/tmp/manifest` as non-root
    And I remove colors from output
    Then I will see the following on stdout:
      """
      No USNs found that affects this system
      """

    Examples: ubuntu
      | release | machine_type  |
      | xenial  | lxd-container |
