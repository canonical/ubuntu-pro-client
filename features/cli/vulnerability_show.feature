Feature: CLI vulnerability show command

  Scenario Outline: CLI vulnerability show
    Given a `<release>` `<machine_type>` machine with ubuntu-advantage-tools installed
    When I verify that running `pro vulnerability show invalid` `as non-root` exits `1`
    Then I will see the following on stderr:
      """
      Error: issue "invalid" is not recognized.
      Usage: "pro vulnerability show CVE-yyyy-nnnn" or "pro vulnerability show USN-nnnn"
      """
    When I push static file `security_issues_xenial` to machine
    And I run `pro vulnerability show CVE-2024-7542 --data-file=/tmp/security_issues_xenial` as non-root
    Then stdout matches regexp:
      """
      CVE-2024-7542
      Public URL: https://ubuntu.com/CVE-2024-7542
      Ubuntu vulnerability data published at: .*
      APT package information updated at: .*

      CVE-2024-7542 does not affect your system.
      """
    When I run `apt update` with sudo
    And I run `apt install vim=2:7.4.1689-3ubuntu1.5 -y` with sudo
    And I run `pro vulnerability show <cve> --data-file=/tmp/security_issues_xenial` as non-root
    And I remove colors from output
    Then stdout matches regexp:
      """
      CVE-2022-2286
      Public URL: https://ubuntu.com/CVE-2022-2286
      Published at: 2022-07-02 19:15:00
      Ubuntu vulnerability data published at: .*
      APT package information updated at: .*
      Ubuntu priority: low
      CVSS score: 7.8
      CVSS severity: high

      \[DESCRIPTION\]
      Out-of-bounds Read in GitHub repository vim/vim prior to 9.0.

      \[AFFECTED INSTALLED PACKAGES\]
      NAME         STATUS  CURRENT VERSION        FIXED BY                     FIX AVAILABLE FROM
      vim          fixed   2:7.4.1689-3ubuntu1.5  2:7.4.1689-3ubuntu1.5\+esm19  esm-infra
      vim-common   fixed   2:7.4.1689-3ubuntu1.5  2:7.4.1689-3ubuntu1.5\+esm19  esm-infra
      vim-runtime  fixed   2:7.4.1689-3ubuntu1.5  2:7.4.1689-3ubuntu1.5\+esm19  esm-infra
      vim-tiny     fixed   2:7.4.1689-3ubuntu1.5  2:7.4.1689-3ubuntu1.5\+esm19  esm-infra

      \[RELATED USNs\]
      VULNERABILITY  TITLE                AFFECTED INSTALLED PACKAGES
      USN-6270-1     Vim vulnerabilities  vim
      """
    When I run `pro vulnerability show <unfixable_cve> --data-file=/tmp/security_issues_xenial` as non-root
    And I remove colors from output
    Then stdout matches regexp:
      """
      CVE-2024-8088
      Public URL: https://ubuntu.com/CVE-2024-8088
      Published at: 2024-08-22 19:15:00
      Ubuntu vulnerability data published at: .*
      APT package information updated at: .*
      Ubuntu priority: medium
      CVSS score: None
      CVSS severity: None

      \[DESCRIPTION\]
      There is a HIGH severity vulnerability affecting the CPython "zipfile"
      module affecting "zipfile.Path". Note that the more common API
      "zipfile.ZipFile" class is unaffected.
      When iterating over names of entries in a zip archive \(for example, methods
      of "zipfile.Path" like "namelist\(\)", "iterdir\(\)", etc\)
      the process can be put into an infinite loop with a maliciously crafted
      zip archive. This defect applies when reading only metadata or extracting
      the contents of the zip archive. Programs that are not handling
      user-controlled zip archives are not affected.

      \[AFFECTED INSTALLED PACKAGES\]
      NAME                  STATUS      CURRENT VERSION          FIXED BY  FIX AVAILABLE FROM
      libpython3.5          vulnerable  3.5.2-2ubuntu0~16.04.13  -         no-fix
      libpython3.5-minimal  vulnerable  3.5.2-2ubuntu0~16.04.13  -         no-fix
      libpython3.5-stdlib   vulnerable  3.5.2-2ubuntu0~16.04.13  -         no-fix
      python3.5             vulnerable  3.5.2-2ubuntu0~16.04.13  -         no-fix
      python3.5-minimal     vulnerable  3.5.2-2ubuntu0~16.04.13  -         no-fix

      \[NOTES\]
      mdeslaur> The original fix lead to a regression, see subsequent commit.
      There are two more commits in the Lib/zipfile directory that are
      possibly related to this issue.
      """
    When I run `pro vulnerability show <usn> --data-file=/tmp/security_issues_xenial` as non-root
    And I remove colors from output
    Then stdout matches regexp:
      """
      USN-4976-2
      Public URL: https://ubuntu.com/USN-4976-2
      Published at: 2022-09-07 15:22:39
      Ubuntu vulnerability data published at: .*
      APT package information updated at: .*

      \[DESCRIPTION\]
      USN-4976-1 fixed a vulnerability in Dnsmasq. This update provides
      the corresponding update for Ubuntu 16.04 ESM.

      Dnsmasq has been updated to 2.79-1 for Ubuntu 16.04 ESM in order to fix
      some security issues.

      Original advisory details:

       Petr Mensik discovered that Dnsmasq incorrectly randomized source ports in
       certain configurations. A remote attacker could possibly use this issue to
       facilitate DNS cache poisoning attacks.


      \[AFFECTED INSTALLED PACKAGES\]
      NAME          CURRENT VERSION         FIXED BY                    FIX AVAILABLE FROM
      dnsmasq-base  2.75-1ubuntu0.16.04.10  2.79-1ubuntu0.16.04.1\+esm1  esm-infra

      \[RELATED CVEs\]
      VULNERABILITY  PRIORITY  AFFECTED INSTALLED PACKAGES
      CVE-2021-3448  low       dnsmasq
      """
    When I run `mkdir -p /var/lib/ubuntu-advantage/vulnerability-data/xenial/` with sudo
    When I run `cp /tmp/security_issues_xenial /var/lib/ubuntu-advantage/vulnerability-data/xenial/vilnerability-cache.json` with sudo
    And I create the file `/var/lib/ubuntu-advantage/vulnerability-data/xenial/vulnerability-publish-date` with the following:
      """
      {"cache_date": "Thu, 10 Sep 2024 01:40:05 GMT"}
      """
    And I run `pro vulnerability show <usn>` with sudo
    And I remove colors from output
    Then stdout matches regexp:
      """
      The vulnerabilities data used in the system is outdated by \d+ days/hours
      To update the data please run with --update:

          \$ pro vulnerability show <vulnerability_issue> --update

      .*USN-4976-2
      Public URL: https://ubuntu.com/USN-4976-2
      Published at: 2022-09-07 15:22:39
      """

    Examples: ubuntu
      | release | machine_type  | cve           | unfixable_cve | usn        |
      | xenial  | lxd-container | CVE-2022-2286 | CVE-2024-8088 | USN-4976-2 |
